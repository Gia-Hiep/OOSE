package com.app.servlet; 

import com.app.dao.CustomerDAO; 
import com.app.service.CustomerSearchService; 
import com.app.service.SearchResult; 

import javax.servlet.ServletException; 
import javax.servlet.annotation.WebServlet; 
import javax.servlet.http.*; 

import java.io.IOException; 

/**
 * VN_Servlet tim kiem khach hang.
 */
@WebServlet("/customers") // VN_Map URL /customers toi servlet
public class SearchServlet extends HttpServlet { // VN_Khai bao class servlet

    /**
     * VN_serialVersionUID cua servlet.
     */
    private static final long serialVersionUID = 1L; // VN_Khai bao serialVersionUID

    /**
     * VN_Duong dan JSP hien thi man hinh tim kiem.
     */
    private static final String VIEW = "/search.jsp"; // VN_Khai bao duong dan JSP

    /**
     * VN_DAO thao tac du lieu khach hang.
     */
    private final CustomerDAO customerDAO = new CustomerDAO(); // VN_Tao doi tuong DAO

    /**
     * VN_Service xu ly logic tim kiem khach hang.
     */
    private final CustomerSearchService service =
            new CustomerSearchService(customerDAO); // VN_Khoi tao service voi DAO

    /**
     * VN_Xu ly request GET cua man hinh tim kiem.
     *
     * @param req  HttpServletRequest
     * @param resp HttpServletResponse
     * @throws ServletException
     * @throws IOException
     */
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException { // VN_Dinh nghia ham doGet

        HttpSession session = req.getSession(false); // VN_Lay session hien tai khong tao moi

        if (session == null) { // VN_Kiem tra session co ton tai khong
            resp.sendRedirect(req.getContextPath() + "/login"); // VN_Redirect ve man hinh login
            return; // VN_Ket thuc xu ly
        }

        // VN_Lay ten nguoi dang nhap uu tien LOGIN_USERNAME
        String userName = (String) session.getAttribute("LOGIN_USERNAME"); // VN_Lay LOGIN_USERNAME

        if (userName == null || userName.trim().isEmpty()) { // VN_Neu chua co LOGIN_USERNAME
            userName = (String) session.getAttribute("LOGIN_USER"); // VN_Fallback sang LOGIN_USER
        }

        if (userName == null || userName.trim().isEmpty()) { // VN_Khong lay duoc thong tin dang nhap
            resp.sendRedirect(req.getContextPath() + "/login"); // VN_Redirect ve login
            return; // VN_Ket thuc xu ly
        }

        SearchResult r = service.initFromLogin(userName); // VN_Khoi tao du lieu tim kiem theo user

        req.setAttribute("loginUser", r.getLoginUserName()); // VN_Set ten nguoi dang nhap

        req.setAttribute("txtCustomerName", r.getCustomerName()); // VN_Set ten khach hang ban dau
        req.setAttribute("cboSex", r.getSex()); // VN_Set gioi tinh ban dau
        req.setAttribute("txtBirthdayFrom", r.getBirthdayFrom()); // VN_Set ngay sinh tu
        req.setAttribute("txtBirthdayTo", r.getBirthdayTo()); // VN_Set ngay sinh den

        req.setAttribute("rows", r.getRows()); // VN_Set danh sach khach hang toi da 15 dong

        req.setAttribute("total", r.getTotal()); // VN_Set tong so record
        req.setAttribute("page", r.getPage()); // VN_Set trang hien tai
        req.setAttribute("lastPage", r.getLastPage()); // VN_Set tong so trang

        req.getRequestDispatcher(VIEW).forward(req, resp); // VN_Forward sang JSP
    }
}
